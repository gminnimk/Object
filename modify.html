<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수정페이지</title>
    <link rel="stylesheet" href="./css/write.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <!-- JQuery Import -->

    <script type="module">

        // Firebase SDK 라이브러리 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
        import { query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyB3ookWJ_UhcAQN3g_GFe8igPGrRhhSEPM",
            authDomain: "object-4dce6.firebaseapp.com",
            projectId: "object-4dce6",
            storageBucket: "object-4dce6.appspot.com",
            messagingSenderId: "1016569423981",
            appId: "1:1016569423981:web:4742c10d53bc9ad4ef7764",
            measurementId: "G-2ND0Q8WYC3"
        };

        // Firebase 인스턴스 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        //Query String - id 값 가져오기
        const Keydata = new URLSearchParams(location.search).get('date');

        //데이터 넘길 변수 (9개)
        let name;
        let mbti;
        let pw;
        let img;
        let blog;
        let github;
        let word;
        let intro;
        let date;

        //DB에서 id 값에 맞는 특정 데이터 가져오기
        const q = query(
            collection(db, 'post'),
            // where('date', '==', Keydata)
        );
        const querySnapshot = await getDocs(q);

        querySnapshot.forEach((el) => {

            name = el.data().name;
            mbti = el.data().mbti;
            pw = el.data().pw;
            img = el.data().img;
            blog = el.data().blog;
            github = el.data().github;
            word = el.data().word;
            intro = el.data().intro;
            date = el.data().date;

            console.log(el.data()) // Test : 불러오기 완료 (QueryString 협의해야함)

        });

        //DB에서 가져온 데이터 화면에 보여주기
        $("#name").val(name);
        $("#mbti").val(mbti);
        $("#pw").val(pw);
        //$("#img").val(img);
        $("#img2").val(img);
        //$("#picture").attr("src", img);
        $("#thumbnail").attr("src", img);
        $("#blog").val(blog);
        $("#github").val(github);
        $("#word").val(word);
        $("#intro").val(intro);
        $("#date").val(date);

        // 현재 날짜, 시간 을 "YYYY-MM-DD hh:mm:ss" format 으로 변경하는 function
        function dateFormat(date) {

            let dateFormat = date.getFullYear() +

                '-' + ((date.getMonth() + 1) < 9 ? "0" + (date.getMonth() + 1) : (date.getMonth() + 1)) +
                '-' + ((date.getDate()) < 9 ? "0" + (date.getDate()) : (date.getDate())) +
                ' ' + ((date.getHours()) < 9 ? "0" + (date.getHours()) : (date.getHours())) +
                ':' + ((date.getMinutes()) < 9 ? "0" + (date.getMinutes()) : (date.getMinutes())) +
                ':' + ((date.getSeconds()) < 9 ? "0" + (date.getSeconds()) : (date.getSeconds()));

            return dateFormat;
        }

        console.log(dateFormat(new Date())); // 날짜 형식 변환 테스트 완료

        // //글 내용 수정 된 거 DB에 업데이트
        // $('#write').click(async function () {

        //     let name_change = $('#name').val();
        //     let mbti_change = $('#mbti').val();
        //     // let pw_change = $('#pw').val();
        //     let img_change = $('#img').val();
        //     let blog_change = $('#blog').val();
        //     let github_change = $('#github').val();
        //     let word_change = $('#word').val();
        //     let intro_change = $('#intro').val();
        //     let date_change = $('#date').val();

        //     const storage = getStorage(app);

        //     //// img 선택 시
        //     // const file = document.querySelector('#img').files[0];
        //     // let img_new;

        //     // const storageRef = ref(storage, 'images/' + file.name + date2); // 사진을 업로드하고
        //     // uploadBytes(storageRef, file).then((snapshot) => {
        //     //     console.log('Uploaded a blob or file!');

        //     //     getDownloadURL(snapshot.ref).then((url) => { // url을 받는다
        //     //         console.log('File available at', url);
        //     //         // ...
        //     //         img_new = url;
        //     //     }).then(async () => {
        //     //         const minpRef = doc(db, "minp", "post" + date_id);

        //     //         await updateDoc(minpRef, {
        //     //             title: titleRef,
        //     //             content: contentRef,
        //     //             img: img_new
        //     //         });

        //     //         console.log("img  :", img_new);
        //     //         location.href = `./show.html?date_id=${date_id}`;
        //     //         alert('작성 완료'); // 작성 완료라는 알람을 띄운다
        //     //     })
        //     // });
        //     //

        //     const minpRef = doc(db, "post", "post" + date_id);

        //     await updateDoc(minpRef, {
        //         title: titleRef,
        //         content: contentRef,
        //         img: img
        //     });

        //     location.href = `./show.html?date_id=${date_id}`;
        // });

    </script>

</head>

<body>

    <header>
        <h1>수정 페이지</h1>
    </header>

    <main>

        <div class="write-flex">

            <div class="write-container">
                <label for="name">이름</label>
                <input id="name" class="write-container-space250" type="text" placeholder="이름을 입력해주세요" />
            </div>

            <div class="write-container side-margin50">
                <label for="mbti">MBTI</label>
                <input id="mbti" class="write-container-space130" type="text" placeholder="MBTI" />
            </div>
        
        </div>

        <div class="write-container-img">
            <label for="img">사진</label>
            <input id="img" class="write-container-input-file" type="file" accept="image/*" />
            <div class="write-container-thumbnail">
              <img id="thumbnail" alt="..." src="" />
            </div>
        </div>

        <div id="imgbox", class="modify-main-container">
            <label for="img2">이미지</label>
            <input id="img2" class="modify-main-container-title" type="text" placeholder="이미지 링크 주소를 입력해주세요" />
            <img id="picture" src="" class="card-img-top" alt="...">
        </div>

        <div class="write-container">
            <label for="blog">블로그 주소</label>
            <input id="blog" class="write-container-space500" type="text" placeholder="블로그 주소를 입력해주세요" />
        </div>

        <div class="write-container">
            <label for="github">깃허브 주소</label>
            <input id="github" class="write-container-space500" type="text" placeholder="깃허브 주소를 입력해주세요" />
        </div>

        <div class="write-container">
            <label for="word">한마디</label>
            <input id="word" class="write-container-spaceAll" type="text" placeholder="한마디를 적어주세요" />
        </div>

        <div class="write-container">
            <label for="intro">자기소개</label>
            <textarea id="intro" placeholder="자기소개를 적어주세요"></textarea>
        </div>

        <div class="write-footer">
            <button id="introBtn" class="write-footer-introBtn" type="button">수정</button>
            <button id="cancleBtn" class="write-footer-cancleBtn" type="button">취소</button>
        </div>

    </main>

    <script>
        $("#thumbnail").on("click", function () {
            $("#img").click();
        })
    </script>
</body>

</html>